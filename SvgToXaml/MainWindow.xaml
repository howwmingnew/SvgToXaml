<Window
    x:Class="SvgToXaml.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:explorer="clr-namespace:SvgToXaml.Explorer"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewModels="clr-namespace:SvgToXaml.ViewModels"
    xmlns:wrapPanel="clr-namespace:SvgToXaml.WrapPanel"
    Title="SvgToXaml"
    d:DataContext="{x:Static viewModels:SvgImagesViewModel.DesignInstance}"
    AllowDrop="True"
    Background="#FF1E1E1E"
    Drop="MainWindow_OnDrop"
    FontFamily="Segoe UI"
    Foreground="#FFCCCCCC"
    Icon="icon.ico"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">
    <Window.Resources>
        <!-- Export Icon -->
        <DrawingImage x:Key="SaveDrawingImage">
            <DrawingImage.Drawing>
                <DrawingGroup ClipGeometry="M0,0 V512 H512 V0 H0 Z">
                    <GeometryDrawing Brush="#FFCCCCCC" Geometry="F1 M512,512z M0,0z M146.365,243.417L196.529,243.417 196.529,200.195 315.468,200.195 315.468,243.417 365.634,243.417 255.999,353.243 146.365,243.417z M196.529,123.862L315.468,123.862 315.468,93.028 196.529,93.028 196.529,123.862z M345.469,85.095L345.469,131.409C388.036,160.522 414.93,208.679 414.93,262.805 414.93,305.258 398.399,345.168 368.381,375.186 338.363,405.204 298.452,421.735 256,421.735 213.549,421.735 173.638,405.204 143.62,375.186 113.601,345.168 97.07,305.258 97.07,262.805 97.07,208.805 123.864,160.59 166.529,131.41L166.529,85.095C101.604,117.849 57.07,185.122 57.07,262.806 57.07,372.673 146.134,461.736 256,461.736 365.867,461.736 454.93,372.674 454.93,262.806 454.93,185.12 410.396,117.847 345.469,85.095z M315.469,180.195L315.469,143.862 196.529,143.862 196.529,180.195 315.469,180.195z M315.469,73.028L315.469,50.265 196.529,50.265 196.529,73.029 315.469,73.029z" />
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>
        <!-- Folder Open Icon -->
        <DrawingImage x:Key="FolderOpenDrawingImage">
            <DrawingImage.Drawing>
                <GeometryDrawing Brush="#FFCCCCCC" Geometry="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" />
            </DrawingImage.Drawing>
        </DrawingImage>
    </Window.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="240" MinWidth="160" />
            <ColumnDefinition Width="4" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- ========== TOOLBAR ========== -->
        <Border
            Grid.Row="0"
            Grid.Column="0"
            Grid.ColumnSpan="3"
            Style="{StaticResource ToolBarPanelStyle}">
            <DockPanel>
                <!-- Right-side controls -->
                <Button
                    Margin="3,0"
                    Command="{Binding ToggleBackgroundCommand}"
                    Content="{Binding BackgroundLabel}"
                    DockPanel.Dock="Right"
                    Style="{StaticResource ToolBarButtonStyle}"
                    ToolTip="切換預覽背景（深灰 / 淺灰 / 棋盤格）" />
                <Slider
                    x:Name="Slider"
                    Width="110"
                    Margin="6,0"
                    VerticalAlignment="Center"
                    DockPanel.Dock="Right"
                    LargeChange="8"
                    Maximum="500"
                    Minimum="16"
                    Orientation="Horizontal"
                    SmallChange="2"
                    ToolTip="調整圖示大小"
                    Value="96" />
                <Rectangle DockPanel.Dock="Right" Style="{StaticResource ToolBarSeparatorStyle}" />
                <Button
                    Margin="3,0"
                    Command="{Binding ExportDirCommand}"
                    DockPanel.Dock="Right"
                    Style="{StaticResource ToolBarButtonStyle}"
                    ToolTip="匯出所有 SVG 為 XAML">
                    <Image Width="18" Height="18" Source="{StaticResource SaveDrawingImage}" />
                </Button>
                <Button
                    Margin="3,0"
                    Command="{Binding OpenFolderCommand}"
                    DockPanel.Dock="Right"
                    Style="{StaticResource ToolBarButtonStyle}"
                    ToolTip="開啟資料夾">
                    <Image Width="18" Height="18" Source="{StaticResource FolderOpenDrawingImage}" />
                </Button>
                <Rectangle DockPanel.Dock="Right" Style="{StaticResource ToolBarSeparatorStyle}" />
                <!-- Address bar fills remaining space -->
                <TextBox
                    Margin="2,0"
                    Style="{StaticResource AddressBarStyle}"
                    TabIndex="1"
                    Text="{Binding CurrentDir, Mode=TwoWay}" />
            </DockPanel>
        </Border>

        <!-- ========== LEFT: FOLDER TREE ========== -->
        <Border
            Grid.Row="1"
            Grid.Column="0"
            Background="#FF252526">
            <explorer:FolderTree
                x:Name="FolderTree"
                ContextMenuCommands="{Binding ContextMenuCommands}"
                CurrentFolder="{Binding CurrentDir, Mode=TwoWay}"
                TabIndex="3" />
        </Border>

        <!-- ========== GRID SPLITTER ========== -->
        <GridSplitter
            Grid.Row="1"
            Grid.Column="1"
            Width="4"
            ResizeBehavior="PreviousAndNext"
            ResizeDirection="Columns"
            Style="{StaticResource DarkGridSplitterStyle}" />

        <!-- ========== RIGHT: ICON LIST + STATUS BAR ========== -->
        <Grid Grid.Row="1" Grid.Column="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Icon ListBox -->
            <ListBox
                Grid.Row="0"
                Background="{Binding PreviewBackgroundBrush}"
                BorderThickness="0"
                ItemsSource="{Binding Images}"
                ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                SelectionMode="Single">
                <!-- Explicit template: standard ScrollViewer with dark scrollbars -->
                <ListBox.Template>
                    <ControlTemplate TargetType="ListBox">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ScrollViewer Focusable="False"
                                          Padding="{TemplateBinding Padding}"
                                          Style="{StaticResource DarkScrollViewerStyle}">
                                <ItemsPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                            </ScrollViewer>
                        </Border>
                    </ControlTemplate>
                </ListBox.Template>
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <wrapPanel:VirtualizingWrapPanel ItemHeight="{Binding ElementName=Slider, Path=Value}" ItemWidth="{Binding ElementName=Slider, Path=Value}" />
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="3" />
                        <Setter Property="Background" Value="Transparent" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <Border
                                        x:Name="ItemBorder"
                                        Background="#22FFFFFF"
                                        BorderBrush="#18FFFFFF"
                                        BorderThickness="1"
                                        CornerRadius="6"
                                        Padding="0"
                                        SnapsToDevicePixels="True">
                                        <ContentPresenter />
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="ItemBorder" Property="Background" Value="#28FFFFFF" />
                                            <Setter TargetName="ItemBorder" Property="BorderBrush" Value="#30FFFFFF" />
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="ItemBorder" Property="Background" Value="#40264F78" />
                                            <Setter TargetName="ItemBorder" Property="BorderBrush" Value="#FF3794FF" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type viewModels:ImageBaseViewModel}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <!-- SVG Icon -->
                            <Image
                                Grid.Row="0"
                                Margin="6,6,6,2"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Source="{Binding PreviewSource}">
                                <Image.InputBindings>
                                    <MouseBinding Command="{Binding CopyXamlCommand}" Gesture="LeftDoubleClick" />
                                </Image.InputBindings>
                            </Image>
                            <!-- Complex SVG badge -->
                            <TextBlock
                                x:Name="ComplexBadge"
                                Grid.Row="0"
                                Margin="4,2"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                FontSize="9"
                                FontWeight="Bold"
                                Foreground="Orange"
                                Text="DI"
                                ToolTip="複雜 SVG：含漸層或特殊效果，將輸出 DrawingImage 格式"
                                Visibility="{Binding IsComplexSvg, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            <!-- Filename label -->
                            <Border Grid.Row="1"
                                    Margin="0"
                                    Padding="3,2"
                                    CornerRadius="0,0,5,5"
                                    Background="#60000000">
                                <TextBlock
                                    FontSize="11"
                                    Foreground="#FFDDDDDD"
                                    Text="{Binding Filename}"
                                    TextAlignment="Center"
                                    TextTrimming="CharacterEllipsis"
                                    ToolTip="{Binding Filename}" />
                            </Border>
                            <!-- Context Menu -->
                            <Grid.ContextMenu>
                                <ContextMenu Style="{StaticResource DarkContextMenuStyle}">
                                    <MenuItem
                                        Command="{Binding CopyXamlCommand}"
                                        Header="複製 XAML"
                                        Style="{StaticResource DarkMenuItemStyle}" />
                                    <MenuItem
                                        Command="{Binding OpenDetailCommand}"
                                        Header="檢視詳細"
                                        Style="{StaticResource DarkMenuItemStyle}" />
                                    <MenuItem
                                        Command="{Binding OpenFileCommand}"
                                        Header="開啟檔案"
                                        Style="{StaticResource DarkMenuItemStyle}" />
                                </ContextMenu>
                            </Grid.ContextMenu>
                        </Grid>
                        <DataTemplate.Triggers>
                            <DataTrigger Binding="{Binding HasSvg}" Value="false">
                                <Setter TargetName="ComplexBadge" Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <!-- Toast Notification -->
            <Border
                x:Name="ToastBorder"
                Grid.Row="0"
                Margin="0,0,0,50"
                HorizontalAlignment="Center"
                VerticalAlignment="Bottom"
                IsHitTestVisible="False"
                Opacity="0"
                Panel.ZIndex="10"
                Style="{StaticResource ToastBorderStyle}">
                <TextBlock
                    FontSize="14"
                    Foreground="White"
                    Text="已複製到剪貼簿" />
            </Border>

            <!-- Status Bar -->
            <Border
                Grid.Row="1"
                Style="{StaticResource StatusBarPanelStyle}">
                <DockPanel>
                    <Button
                        Margin="2,0"
                        Command="{Binding OpenFileCommand}"
                        DockPanel.Dock="Right"
                        Style="{StaticResource StatusBarButtonStyle}"
                        ToolTip="開啟檔案">
                        <TextBlock FontSize="11" Foreground="White" Text="..." />
                    </Button>
                    <TextBox
                        Margin="2,0"
                        Style="{StaticResource StatusBarTextStyle}"
                        Text="{Binding SelectedItem.Filepath, Mode=OneWay}" />
                </DockPanel>
            </Border>
        </Grid>
    </Grid>
</Window>
